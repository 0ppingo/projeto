--// SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

--// PLAYER
local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

--// REMOTES
local Remotes = ReplicatedStorage:WaitForChild("CombatRemotesRemotes")
local BlockEvent = Remotes:WaitForChild("BlockEvent")
local DodgeEvent = Remotes:WaitForChild("DodgeEvent")

--// CONFIG
local DEFENSE_ENABLED = false

local BLOCK_REGEN_TIME = 4
local MIN_STAMINA_DODGE = 30
local SAFE_DODGE_DELAY = 0.15

--// STATE
local State = {
	blocking = false,
	blockBroken = false,
	lastHit = tick(),
	lastHealth = 100,

	-- >>> NOVO (shield tracking)
	lastBlock = nil,
	lastBlockTime = tick()
}

--// UI (mobile-friendly)
local gui = Instance.new("ScreenGui")
gui.Name = "DefenseToggleGui"
gui.ResetOnSpawn = false
gui.Parent = LocalPlayer:WaitForChild("PlayerGui")

local button = Instance.new("TextButton")
button.Size = UDim2.fromScale(0.22, 0.08)
button.Position = UDim2.fromScale(0.39, 0.85)
button.Text = "DEFESA OFF"
button.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
button.TextScaled = true
button.Parent = gui

button.Activated:Connect(function()
	DEFENSE_ENABLED = not DEFENSE_ENABLED
	button.Text = DEFENSE_ENABLED and "DEFESA ON" or "DEFESA OFF"
	button.BackgroundColor3 = DEFENSE_ENABLED
		and Color3.fromRGB(60, 180, 90)
		or Color3.fromRGB(180, 60, 60)

	if DEFENSE_ENABLED then
		BlockEvent:FireServer("blockStart")
		State.blocking = true
	else
		BlockEvent:FireServer("unblocking")
		State.blocking = false
	end
end)

--// HELPERS
local function GetHealth()
	local label =
		Character.HumanoidRootPart
		[LocalPlayer.Name]
		.CenterContainer
		.HealthStaminaContainer
		.HealthBarContainer
		.TextLabel

	return tonumber(label.Text)
end

local function GetStamina()
	local label =
		Character.HumanoidRootPart
		[LocalPlayer.Name]
		.CenterContainer
		.HealthStaminaContainer
		.StaminaBarContainer
		.TextLabel

	return tonumber(label.Text)
end

local function GetBlock()
	return tonumber(
		Character.HumanoidRootPart
		.BlockHealthVisualizerV2
		.MainContainer
		.HealthNumber
		.ContentText
	)
end

--// CORE LOOP
RunService.RenderStepped:Connect(function()
	if not DEFENSE_ENABLED then return end

	local currentBlock = GetBlock()

	-- Inicializar valores
	if State.lastBlock == nil then
		State.lastBlock = currentBlock
		State.lastBlockTime = tick()
	end

	-- >>> NOVO: detectar press√£o no shield
	if currentBlock < State.lastBlock then
		local delta = State.lastBlock - currentBlock
		local dt = tick() - State.lastBlockTime

		if delta >= 2 and dt <= 0.3 then
			if GetStamina() >= MIN_STAMINA_DODGE and not State.blockBroken then
				DodgeEvent:FireServer("back")
			end
		end

		State.lastBlockTime = tick()
	end

	State.lastBlock = currentBlock

	-- Shield quebrou
	if currentBlock <= 0 then
		if not State.blockBroken then
			State.blockBroken = true
			State.lastHit = tick()
			BlockEvent:FireServer("unblocking")
			State.blocking = false
		end
	else
		-- Shield voltou
		if State.blockBroken and tick() - State.lastHit >= BLOCK_REGEN_TIME then
			State.blockBroken = false
			BlockEvent:FireServer("blockStart")
			State.blocking = true
		end
	end

	-- Garantir block ativo
	if not State.blockBroken and not State.blocking then
		BlockEvent:FireServer("blockStart")
		State.blocking = true
	end
end)

--// DODGE POR DANO (mantido)
Character.HumanoidRootPart
	[LocalPlayer.Name]
	.CenterContainer
	.HealthStaminaContainer
	.HealthBarContainer
	.TextLabel
	:GetPropertyChangedSignal("Text")
	:Connect(function()

	if not DEFENSE_ENABLED then return end

	local currentHealth = GetHealth()

	if currentHealth < State.lastHealth then
		State.lastHit = tick()

		if GetStamina() >= MIN_STAMINA_DODGE and not State.blockBroken then
			task.wait(SAFE_DODGE_DELAY)
			DodgeEvent:FireServer("back")
		end
	end

	State.lastHealth = currentHealth
end)
